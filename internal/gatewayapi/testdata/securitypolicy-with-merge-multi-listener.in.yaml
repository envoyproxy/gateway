gateways:
- apiVersion: gateway.networking.k8s.io/v1
  kind: Gateway
  metadata:
    namespace: envoy-gateway
    name: gateway-1
  spec:
    gatewayClassName: envoy-gateway-class
    listeners:
    - name: http-a
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All
    - name: http-b
      protocol: HTTP
      port: 8080
      allowedRoutes:
        namespaces:
          from: All
httpRoutes:
- apiVersion: gateway.networking.k8s.io/v1
  kind: HTTPRoute
  metadata:
    namespace: default
    name: httproute-1
  spec:
    parentRefs:
    # Route attaches to BOTH listeners
    - namespace: envoy-gateway
      name: gateway-1
      sectionName: http-a
    - namespace: envoy-gateway
      name: gateway-1
      sectionName: http-b
    rules:
    - matches:
      - path:
          value: "/foo"
      backendRefs:
      - name: service-1
        port: 8080
securityPolicies:
# Policy for listener-a: BasicAuth
- apiVersion: gateway.envoyproxy.io/v1alpha1
  kind: SecurityPolicy
  metadata:
    namespace: envoy-gateway
    name: policy-for-listener-a
  spec:
    targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: gateway-1
      sectionName: http-a
    basicAuth:
      users:
        name: users-secret-a
# Policy for listener-b: ExtAuth (different from listener-a)
- apiVersion: gateway.envoyproxy.io/v1alpha1
  kind: SecurityPolicy
  metadata:
    namespace: envoy-gateway
    name: policy-for-listener-b
  spec:
    targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: gateway-1
      sectionName: http-b
    extAuth:
      http:
        backendRefs:
        - name: auth-service
          namespace: envoy-gateway
          port: 9001
# Route-level policy that merges with parent
- apiVersion: gateway.envoyproxy.io/v1alpha1
  kind: SecurityPolicy
  metadata:
    namespace: default
    name: policy-for-route
  spec:
    mergeType: StrategicMerge
    targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: httproute-1
    cors:
      allowOrigins:
      - "https://www.example.com"
      allowMethods:
      - GET
      - POST
services:
- apiVersion: v1
  kind: Service
  metadata:
    namespace: envoy-gateway
    name: auth-service
  spec:
    ports:
    - port: 9001
      name: http
      protocol: TCP
referenceGrants:
- apiVersion: gateway.networking.k8s.io/v1alpha2
  kind: ReferenceGrant
  metadata:
    namespace: envoy-gateway
    name: allow-securitypolicy-to-auth-service
  spec:
    from:
    - group: gateway.envoyproxy.io
      kind: SecurityPolicy
      namespace: default
    to:
    - group: ""
      kind: Service
endpointSlices:
- apiVersion: discovery.k8s.io/v1
  kind: EndpointSlice
  metadata:
    name: endpointslice-auth-service
    namespace: envoy-gateway
    labels:
      kubernetes.io/service-name: auth-service
  addressType: IPv4
  ports:
  - name: http
    protocol: TCP
    port: 9001
  endpoints:
  - addresses:
    - 10.0.0.1
    conditions:
      ready: true
secrets:
- apiVersion: v1
  kind: Secret
  metadata:
    namespace: envoy-gateway
    name: users-secret-a
  type: Opaque
  data:
    .htpasswd: dXNlcjE6e1NIQX15LzJzWUFqNXlyUUlONFRMMFlkUGRtR05LcGM9
- apiVersion: v1
  kind: Secret
  metadata:
    namespace: default
    name: users-secret-a
  type: Opaque
  data:
    .htpasswd: dXNlcjE6e1NIQX15LzJzWUFqNXlyUUlONFRMMFlkUGRtR05LcGM9
