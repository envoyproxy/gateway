apiVersion: gateway.envoyproxy.io/v1alpha1
kind: Backend
metadata:
  name: otel-collector
spec:
  endpoints:
    - fqdn:
        hostname: localhost
        port: 4317
# Use below for cloud OTLP endpoints
#   endpoints:
#     - fqdn:
#         hostname: otel.example.com
#         port: 443
#   tls:
#     wellKnownCACertificates: System
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: otel-example
spec:
  telemetry:
    metrics:
      sinks:
        - type: OpenTelemetry
          openTelemetry:
            backendRefs:
              - group: gateway.envoyproxy.io
                kind: Backend
                name: otel-collector
            # Delta temporality required for backends like otel-tui and Elastic
            reportCountersAsDeltas: true
            reportHistogramsAsDeltas: true
            # Authorization header sent as gRPC initial metadata
            headers:
              - name: Authorization
                value: Bearer fake
            resourceAttributes:
              service.name: envoy-gateway-example
              service.version: v1.0.0
              deployment.environment: production
    tracing:
      samplingRate: 100
      provider:
        type: OpenTelemetry
        backendRefs:
          - group: gateway.envoyproxy.io
            kind: Backend
            name: otel-collector
        # Authorization header sent as gRPC initial metadata
        openTelemetry:
          headers:
            - name: Authorization
              value: Bearer fake
          resourceAttributes:
            service.name: envoy-gateway-example
            service.version: v1.0.0
            deployment.environment: production
    accessLog:
      settings:
        - format:
            # Text format becomes the OTLP log body
            text: "%REQ(:METHOD)% %REQ(:PATH)% %PROTOCOL% %RESPONSE_CODE%"
            # JSON format becomes OTLP log attributes
            json:
              response_code_details: "%RESPONSE_CODE_DETAILS%"
              upstream_host: "%UPSTREAM_HOST%"
              upstream_cluster: "%UPSTREAM_CLUSTER%"
              upstream_transport_failure_reason: "%UPSTREAM_TRANSPORT_FAILURE_REASON%"
              response_flags: "%RESPONSE_FLAGS%"
              connection_termination_details: "%CONNECTION_TERMINATION_DETAILS%"
          sinks:
            - type: OpenTelemetry
              openTelemetry:
                backendRefs:
                  - group: gateway.envoyproxy.io
                    kind: Backend
                    name: otel-collector
                resourceAttributes:
                  service.name: envoy-gateway-example
                  service.version: v1.0.0
                  deployment.environment: production
                # Authorization header sent as gRPC initial metadata
                headers:
                  - name: Authorization
                    value: Bearer fake
---
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: eg
spec:
  gatewayClassName: eg
  infrastructure:
    parametersRef:
      group: gateway.envoyproxy.io
      kind: EnvoyProxy
      name: otel-example
  listeners:
    - name: http
      protocol: HTTP
      port: 10080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: backend
spec:
  parentRefs:
    - name: eg
  rules:
    - backendRefs:
        - group: gateway.envoyproxy.io
          kind: Backend
          name: httpbin
      matches:
        - path:
            type: PathPrefix
            value: /
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: Backend
metadata:
  name: httpbin
spec:
  endpoints:
    - fqdn:
        hostname: httpbingo.org
        port: 443
  tls:
    wellKnownCACertificates: System
    # TODO: raise a PR to auto-infer SNI from the FQDN when not explicitly set
    sni: httpbingo.org
