name: Site Check
on:
  push:
    branches:
    - "main"
    - "release/v*"
    paths:
    - "site/**"
  pull_request:
    paths:
    - "site/**"

permissions:
  contents: read

defaults:
  run:
    working-directory: ./site

jobs:
  # Markdown linting job
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: 'site/content/**/*.md'

  # Spellcheck job
  spellcheck:
    name: Spellcheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'site/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run cSpell
        uses: streetsidesoftware/cspell-action@v6
        with:
          root: ./site
          files: |
            content/**/*.md
            content/**/*.html
            layouts/**/*.html
            README.md
          incremental_files_only: false

  # Hugo build and validation
  hugo-build:
    name: Hugo Build & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'site/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: 'site/go.sum'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.3'
          extended: true

      - name: Install Node.js dependencies
        run: npm ci

      - name: Initialize Hugo modules
        run: hugo mod get

      - name: Build Hugo site
        run: npm run build

      - name: Validate Hugo build
        run: |
          # Check if public directory was created
          if [ ! -d "public" ]; then
            echo "Error: Hugo build did not create public directory"
            exit 1
          fi

          # Check if index.html exists
          if [ ! -f "public/index.html" ]; then
            echo "Error: Hugo build did not create index.html"
            exit 1
          fi

          # Check for broken internal links in generated HTML
          find public -name "*.html" -exec grep -l "href.*#.*" {} \; | head -10

  # Link checking job
  link-check:
    name: Link Check
    runs-on: ubuntu-latest
    needs: hugo-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'site/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: 'site/go.sum'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.3'
          extended: true

      - name: Install dependencies
        run: npm ci

      - name: Build site for link checking
        run: npm run build

      - name: Install htmltest
        run: |
          curl -L https://github.com/wjdp/htmltest/releases/download/v0.17.0/htmltest_0.17.0_linux_amd64.tar.gz | tar -xz
          sudo mv htmltest /usr/local/bin/

      - name: Test internal links
        run: htmltest --conf .htmltest.yml || true
        continue-on-error: true

  # YAML and configuration validation
  config-lint:
    name: Config Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: site/
          config_file: .yamllint.yml
          strict: false

      - name: Validate Hugo config
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.3'
          extended: true

      - name: Check Hugo configuration
        run: |
          cd site
          hugo config | head -20

  # Docsy theme validation
  docsy-check:
    name: Docsy Theme Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: 'site/go.sum'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.3'
          extended: true

      - name: Verify Docsy module
        run: |
          cd site
          hugo mod graph | grep docsy
          hugo mod verify

      - name: Check Docsy dependencies
        run: |
          cd site
          # Verify bootstrap is available
          if [ ! -d "node_modules/bootstrap" ]; then
            echo "Warning: Bootstrap not found in node_modules"
          fi

          # Check for Font Awesome
          find node_modules -name "*font*awesome*" -type d | head -3

  # Accessibility check
  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    needs: hugo-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'site/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.147.3'
          extended: true

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Run accessibility tests
        uses: a11ywatch/github-action@v2.1.6
        with:
          website-url: ./site/public
          fix: false
          fail-on-error: false
